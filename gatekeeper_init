#!/bin/sh /etc/rc.common
#
# The MIT License (MIT)
# Copyright (c) 2026 Naresh Mehta (https://www.naresh.se/)
#
# Permission is hereby granted, free of charge, to any person obtaining a copy
# of this software and associated documentation files (the "Software"), to deal
# in the Software without restriction, including without limitation the rights
# to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
# copies of the Software, and to permit persons to whom the Software is
# furnished to do so, subject to the following conditions:
#
# The above copyright notice and this permission notice shall be included in
# all copies or substantial portions of the Software.
#
# THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
# IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
# FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
# AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
# LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
# OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
# SOFTWARE.
#

# gatekeeper_init - OpenWrt init script for gatekeeper static MAC synchronization
# 
# This script runs at system startup (START=95) to initialize the gatekeeper
# firewall rules by populating the static_macs nftables set with MAC addresses
# configured as static DHCP leases in OpenWrt's UCI configuration.
#
# Key Features:
# - Runs during late boot phase to ensure network services are ready
# - Clears existing static_macs set before repopulating (prevents stale entries)
# - Parses UCI DHCP configuration to extract static MAC assignments
# - Adds each static MAC to the nftables firewall set for immediate access
#
# Integration Points:
# - Works with OpenWrt's procd init system
# - Modifies nftables firewall rules via 'fw4' table in 'inet' family
# - Reads from UCI 'dhcp' configuration namespace
#
# Security Considerations:
# - Only processes legitimate static DHCP leases from system config
# - No external input validation needed as UCI config is trusted
# - Failures during MAC addition are logged by nftables but don't stop the script
#
# Extensibility Notes:
# - To add MACs from additional sources, extend the STATIC_MACS extraction logic
# - For custom timing, adjust START parameter (higher values = later execution)
# - To support IPv6, add similar logic for static IPv6 assignments

# OpenWrt init system parameters
START=95  # Late boot position (90-99 range for network-related services)

# Main service start function called by procd
start() {
    # Step 1: Clear the static MAC set to prevent accumulation of stale entries
    # This ensures we start fresh on each boot or service restart
    nft flush set inet fw4 static_macs

    # Step 2: Extract static MAC addresses from UCI DHCP configuration
    # Searches for all .mac= entries and extracts the MAC values
    # Format: uci show dhcp returns key='value' pairs, we extract the value part
    STATIC_MACS=$(uci show dhcp | grep ".mac=" | awk -F"='" '{print $2}' | tr -d "'")

    # Step 3: Iterate through each static MAC and add to firewall set
    # This grants immediate network access to devices with static leases
    for mac in $STATIC_MACS; do
        nft add element inet fw4 static_macs { $mac }
    done
}
