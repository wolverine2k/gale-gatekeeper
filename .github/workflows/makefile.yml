name: Build OpenWrt Package

on:
  push:
    branches: [ "main" ]
    tags: [ "v*" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set package version
      id: version
      run: |
        PKG_VERSION=1.0.0
        PKG_RELEASE=1
        if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
          PKG_VERSION="${GITHUB_REF_NAME#v}"
        fi
        echo "PKG_VERSION=${PKG_VERSION}" >> "$GITHUB_ENV"
        echo "PKG_RELEASE=${PKG_RELEASE}" >> "$GITHUB_ENV"
        echo "IPK_NAME=gatekeeper_${PKG_VERSION}-${PKG_RELEASE}_all.ipk" >> "$GITHUB_ENV"

    - name: Build .ipk package
      run: |
        set -e
        STAGING="$(mktemp -d)"

        # Create install tree
        mkdir -p "${STAGING}/data/usr/bin"
        mkdir -p "${STAGING}/data/etc/init.d"
        mkdir -p "${STAGING}/data/etc/config"
        mkdir -p "${STAGING}/data/etc/gatekeeper"
        mkdir -p "${STAGING}/control"

        # Executable scripts → /usr/bin
        install -m 755 gatekeeper.sh            "${STAGING}/data/usr/bin/gatekeeper.sh"
        install -m 755 tg_bot.sh               "${STAGING}/data/usr/bin/tg_bot.sh"
        install -m 755 gatekeeper_trigger.sh   "${STAGING}/data/usr/bin/gatekeeper_trigger.sh"
        install -m 755 dnsmasq_trigger.sh      "${STAGING}/data/usr/bin/dnsmasq_trigger.sh"
        install -m 755 gatekeeper_sync.sh      "${STAGING}/data/usr/bin/gatekeeper_sync.sh"

        # Firewall rules → /etc/gatekeeper
        install -m 644 gatekeeper.nft          "${STAGING}/data/etc/gatekeeper/gatekeeper.nft"

        # Init scripts → /etc/init.d
        install -m 755 gatekeeper_init              "${STAGING}/data/etc/init.d/gatekeeper_init"
        install -m 755 tg_gatekeeper               "${STAGING}/data/etc/init.d/tg_gatekeeper"
        install -m 755 gatekeeper_trigger_listener "${STAGING}/data/etc/init.d/gatekeeper_trigger_listener"

        # UCI config template → /etc/config
        install -m 644 opkg/etc/config/gatekeeper  "${STAGING}/data/etc/config/gatekeeper"

        # Installed size in KB
        INSTALLED_SIZE=$(du -sk "${STAGING}/data" | cut -f1)

        # control file
        cat > "${STAGING}/control/control" <<EOF
        Package: gatekeeper
        Version: ${PKG_VERSION}-${PKG_RELEASE}
        Depends: jq, curl, coreutils, coreutils-timeout
        Section: net
        Architecture: all
        Installed-Size: ${INSTALLED_SIZE}
        Maintainer: Naresh Mehta <naresh@naresh.se>
        Description: Telegram-based Network Access Control for OpenWrt
         When a new device connects via DHCP, sends a Telegram notification
         with Approve/Deny buttons. Static leases are whitelisted automatically.
        EOF

        # conffiles — preserved across upgrades
        printf '/etc/config/gatekeeper\n' > "${STAGING}/control/conffiles"

        # Build archives
        (cd "${STAGING}/data"    && tar czf "${STAGING}/data.tar.gz"    .)
        (cd "${STAGING}/control" && tar czf "${STAGING}/control.tar.gz" .)
        printf '2.0\n' > "${STAGING}/debian-binary"

        # Pack into .ipk (ar archive)
        (cd "${STAGING}" && ar rcs "${GITHUB_WORKSPACE}/${IPK_NAME}" debian-binary control.tar.gz data.tar.gz)

        echo "Built: ${IPK_NAME}"
        ls -lh "${IPK_NAME}"

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: gatekeeper-ipk
        path: "*.ipk"
        if-no-files-found: error

    - name: Create GitHub Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: "*.ipk"
        generate_release_notes: true
